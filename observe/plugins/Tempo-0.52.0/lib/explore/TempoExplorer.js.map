{"version":3,"sources":["../../../src/explore/TempoExplorer.tsx"],"sourcesContent":["// Copyright 2024 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Box, Stack } from '@mui/material';\nimport { ErrorAlert, ErrorBoundary, LoadingOverlay, NoDataOverlay } from '@perses-dev/components';\nimport { QueryDefinition, isValidTraceId } from '@perses-dev/core';\nimport { Panel } from '@perses-dev/dashboards';\nimport { useExplorerManagerContext } from '@perses-dev/explore';\nimport { DataQueriesProvider, MultiQueryEditor, useDataQueries } from '@perses-dev/plugin-system';\nimport { ReactElement } from 'react';\n\ninterface TracesExplorerQueryParams {\n  queries?: QueryDefinition[];\n}\n\ninterface SearchResultsPanelProps {\n  queries: QueryDefinition[];\n}\n\nfunction SearchResultsPanel({ queries }: SearchResultsPanelProps): ReactElement {\n  const { isFetching, isLoading, queryResults } = useDataQueries('TraceQuery');\n\n  // no query executed, show empty panel\n  if (queryResults.length === 0) {\n    return <></>;\n  }\n\n  if (isLoading || isFetching) {\n    return <LoadingOverlay />;\n  }\n\n  const queryError = queryResults.find((d) => d.error);\n  if (queryError) {\n    throw queryError.error;\n  }\n\n  const tracesFound = queryResults.some((traceData) => (traceData.data?.searchResult ?? []).length > 0);\n  if (!tracesFound) {\n    return <NoDataOverlay resource=\"traces\" />;\n  }\n\n  return (\n    <Stack sx={{ height: '100%' }} gap={2}>\n      <Box sx={{ height: '35%', flexShrink: 0 }}>\n        <Panel\n          panelOptions={{\n            hideHeader: true,\n          }}\n          definition={{\n            kind: 'Panel',\n            spec: { queries, display: { name: '' }, plugin: { kind: 'ScatterChart', spec: {} } },\n          }}\n        />\n      </Box>\n      <Panel\n        sx={{ flexGrow: 1 }}\n        panelOptions={{\n          hideHeader: true,\n        }}\n        definition={{\n          kind: 'Panel',\n          spec: { queries, display: { name: '' }, plugin: { kind: 'TraceTable', spec: {} } },\n        }}\n      />\n    </Stack>\n  );\n}\n\nfunction TracingGanttChartPanel({ queries }: { queries: QueryDefinition[] }): ReactElement {\n  return (\n    <Panel\n      panelOptions={{\n        hideHeader: true,\n      }}\n      definition={{\n        kind: 'Panel',\n        spec: { queries, display: { name: '' }, plugin: { kind: 'TracingGanttChart', spec: {} } },\n      }}\n    />\n  );\n}\n\nexport function TempoExplorer(): ReactElement {\n  const {\n    data: { queries = [] },\n    setData,\n  } = useExplorerManagerContext<TracesExplorerQueryParams>();\n\n  // map TraceQueryDefinition to Definition<UnknownSpec>\n  const definitions = queries.length\n    ? queries.map((query: QueryDefinition) => {\n        return {\n          kind: query.spec.plugin.kind,\n          spec: query.spec.plugin.spec,\n        };\n      })\n    : [];\n\n  // Cannot cast to TempoTraceQuerySpec because 'tempo-plugin' types are not accessible in @perses-dev/explore\n  const isSingleTrace =\n    queries.length === 1 &&\n    queries[0]?.kind === 'TraceQuery' &&\n    queries[0]?.spec.plugin.kind === 'TempoTraceQuery' &&\n    isValidTraceId((queries[0]?.spec.plugin.spec as any).query ?? ''); // eslint-disable-line @typescript-eslint/no-explicit-any\n\n  return (\n    <Stack gap={2} sx={{ width: '100%' }}>\n      <MultiQueryEditor\n        queryTypes={['TraceQuery']}\n        onChange={(newQueries) => setData({ queries: newQueries })}\n        queries={queries}\n      />\n\n      <ErrorBoundary FallbackComponent={ErrorAlert} resetKeys={[queries]}>\n        <DataQueriesProvider definitions={definitions}>\n          <Box height={700}>\n            {isSingleTrace ? <TracingGanttChartPanel queries={queries} /> : <SearchResultsPanel queries={queries} />}\n          </Box>\n        </DataQueriesProvider>\n      </ErrorBoundary>\n    </Stack>\n  );\n}\n"],"names":["Box","Stack","ErrorAlert","ErrorBoundary","LoadingOverlay","NoDataOverlay","isValidTraceId","Panel","useExplorerManagerContext","DataQueriesProvider","MultiQueryEditor","useDataQueries","SearchResultsPanel","queries","isFetching","isLoading","queryResults","length","queryError","find","d","error","tracesFound","some","traceData","data","searchResult","resource","sx","height","gap","flexShrink","panelOptions","hideHeader","definition","kind","spec","display","name","plugin","flexGrow","TracingGanttChartPanel","TempoExplorer","setData","definitions","map","query","isSingleTrace","width","queryTypes","onChange","newQueries","FallbackComponent","resetKeys"],"mappings":"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"}