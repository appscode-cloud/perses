"use strict";(self.webpackChunkTempo=self.webpackChunkTempo||[]).push([["7969"],{50117:function(e,t,r){r.r(t),r.d(t,{TempoTraceQuery:()=>L});var a=r(58891),i=r(14267),o=r(20461);let n="TempoDatasource",s={kind:n},l=async(e,t)=>{if(void 0===e.query||null===e.query||""===e.query)return console.error("TempoTraceQuery is undefined, null, or an empty string."),{searchResult:[]};let r=await t.datasourceStore.listDatasourceSelectItems(n),s=(0,a.datasourceSelectValueToSelector)(e.datasource,t.variableState,r)??{kind:n},l=await t.datasourceStore.getDatasourceClient(s);return(0,i.j)(e.query)?{trace:function(e){let t={resourceSpans:e.batches};for(let e of t.resourceSpans)for(let t of e.scopeSpans)for(let e of t.spans)32!=e.traceId.length&&(e.traceId=c(e.traceId)),16!=e.spanId.length&&(e.spanId=c(e.spanId)),e.parentSpanId&&16!=e.parentSpanId.length&&(e.parentSpanId=c(e.parentSpanId));return t}(await l.query({traceId:e.query})),metadata:{executedQueryString:e.query}}:{searchResult:(await l.searchWithFallback((()=>{let r={q:e.query};if(t.absoluteTimeRange){let{start:e,end:a}=function(e){let{start:t,end:r}=e;return{start:Math.ceil((0,o.getUnixTime)(t)),end:Math.ceil((0,o.getUnixTime)(r))}}(t.absoluteTimeRange);r.start=e,r.end=a}return e.limit&&(r.limit=e.limit),r})())).traces.map(e=>({startTimeUnixMs:1e-6*parseInt(e.startTimeUnixNano),durationMs:e.durationMs??0,traceId:e.traceID,rootServiceName:e.rootServiceName,rootTraceName:e.rootTraceName,serviceStats:e.serviceStats||{}})),metadata:{executedQueryString:e.query}}};function c(e){try{return atob(e).split("").map(e=>e.charCodeAt(0).toString(16).padStart(2,"0").toUpperCase()).join("")}catch{return e}}var u=r(24246),d=r(25283),p=r(90192),m=r(8695),f=r(72629),g=r(75586),h=r(54538),v=r(94776),y=r(68808),b=r(46359),k=r(61262),T=r(70534),S=r(94197);let x=(0,S.Gv)({LineComment:S.pJ.comment,"Parent Resource Span Identifier":S.pJ.labelName,IntrinsicField:S.pJ.labelName,String:S.pJ.string,"Integer Float Duration":S.pJ.number,Static:S.pJ.literal,"Aggregate AggregateExpression":S.pJ.function(S.pJ.keyword),"And Or":S.pJ.logicOperator,"Gt Lt Desc Anc tilde ExperimentalOp":S.pJ.bitwiseOperator,ComparisonOp:S.pJ.compareOperator,Pipe:S.pJ.operator,ScalarOp:S.pJ.arithmeticOperator,"( )":S.pJ.paren,"[ ]":S.pJ.squareBracket,"{ }":S.pJ.brace,"âš ":S.pJ.invalid});var C=r(13018),I=r(29085);async function D(e,t){let{state:r,pos:a}=t,i=function(e,t,r){var a,i,o,n,s,l,c,u,d,p,m,f,g,h,v,y,b,k,S,x,C;let I=r.resolveInner(t,-1);switch(I.type.id){case T.Bu:if((null===I.firstChild||(null===(a=I.firstChild)||void 0===a?void 0:a.type.id)===0)&&!e.sliceDoc(I.from,t).includes("}"))return{scopes:[{kind:"Scopes"},{kind:"TagName",scope:"intrinsic"}],from:t};break;case T.Im:return{scopes:[{kind:"Scopes"},{kind:"TagName",scope:"intrinsic"}],from:t};case T.AW:if((null===(i=I.firstChild)||void 0===i?void 0:i.type.id)===T._z)return{scopes:[{kind:"TagName",scope:"resource"}],from:t};if((null===(o=I.firstChild)||void 0===o?void 0:o.type.id)===T.Dr)return{scopes:[{kind:"TagName",scope:"span"}],from:t};if("."===e.sliceDoc(I.from,I.to))return{scopes:[{kind:"TagName",scope:"resource"},{kind:"TagName",scope:"span"}],from:t};break;case T.xb:if((null===(n=I.parent)||void 0===n?void 0:n.type.id)===T.AW){if(e.sliceDoc(I.parent.from,I.parent.to).includes(":"))return{scopes:[{kind:"TagName",scope:"intrinsic"}],from:I.parent.from};if((null===(l=I.parent)||void 0===l?void 0:null===(s=l.firstChild)||void 0===s?void 0:s.type.id)===T._z)return{scopes:[{kind:"TagName",scope:"resource"}],from:I.from};if((null===(u=I.parent)||void 0===u?void 0:null===(c=u.firstChild)||void 0===c?void 0:c.type.id)===T.Dr)return{scopes:[{kind:"TagName",scope:"span"}],from:I.from};if((null===(p=I.parent)||void 0===p?void 0:null===(d=p.firstChild)||void 0===d?void 0:d.type.id)===T.xb)return{scopes:[{kind:"TagName",scope:"resource"},{kind:"TagName",scope:"span"}],from:I.from}}break;case T.Of:if((null===(f=I.parent)||void 0===f?void 0:null===(m=f.firstChild)||void 0===m?void 0:m.type.id)===T.Im){let r=I.parent.firstChild;return{scopes:[{kind:"TagValue",tag:e.sliceDoc(r.from,r.to)}],from:t}}break;case T.Ld:if((null===(y=I.parent)||void 0===y?void 0:null===(v=y.parent)||void 0===v?void 0:null===(h=v.parent)||void 0===h?void 0:null===(g=h.firstChild)||void 0===g?void 0:g.type.id)===T.Im&&!/^".*"$/.test(e.sliceDoc(I.from,t))){let t=I.parent.parent.parent.firstChild;return{scopes:[{kind:"TagValue",tag:e.sliceDoc(t.from,t.to)}],from:I.from+1}}break;case 0:if((null===(b=I.prevSibling)||void 0===b?void 0:b.type.id)===T.Of&&(null===(S=I.parent)||void 0===S?void 0:null===(k=S.firstChild)||void 0===k?void 0:k.type.id)===T.Im){let t=I.parent.firstChild;return{scopes:[{kind:"TagValue",tag:e.sliceDoc(t.from,t.to)}],from:'"'===e.sliceDoc(I.from,I.from+1)?I.from+1:I.from}}if((null===(x=I.parent)||void 0===x?void 0:x.type.id)===T.Bu||(null===(C=I.parent)||void 0===C?void 0:C.type.id)===T.Im)return{scopes:[{kind:"Scopes"},{kind:"TagName",scope:"intrinsic"}],from:I.from}}}(r,a,(0,k.qz)(r));return i?{options:await q(e,i.scopes),from:i.from,to:i.to}:null}async function q(e,t){let r=[];for(let a of t)switch(a.kind){case"Scopes":r.push(Promise.resolve([{label:"span"},{label:"resource"}]));break;case"TagName":r.push(w(e,a.scope));break;case"TagValue":r.push(O(e,a.tag))}return(await Promise.all(r)).flat()}function N(e){if(!e)return{};let t=(0,I.q0)(e)?e:(0,I.sG)(e);return{start:Math.round(t.start.getTime()/1e3),end:Math.round(t.end.getTime()/1e3)}}async function w(e,t){if(!e.client)return[];let{start:r,end:a}=N(e.timeRange),{limit:i,maxStaleValues:o}=e;return(await e.client.searchTags({scope:t,start:r,end:a,limit:i,maxStaleValues:o})).scopes.flatMap(e=>e.tags).map(e=>({label:e}))}function J(e,t,r,a){let i=t.label;'"'!==e.state.sliceDoc(r-1,r)&&(i='"'+i),'"'!==e.state.sliceDoc(a,a+1)&&(i+='"'),e.dispatch((0,C.$L)(e.state,i,r,a))}async function O(e,t){if(!e.client)return[];let{start:r,end:a}=N(e.timeRange),{limit:i,maxStaleValues:o}=e,n=await e.client.searchTagValues({tag:t,start:r,end:a,limit:i,maxStaleValues:o}),s=[];for(let{type:e,value:t}of n.tagValues)switch(e){case"string":s.push({label:t??"",displayLabel:t??"(empty string)",apply:J});break;case"keyword":case"int":s.push({label:t??"",displayLabel:t??"(empty string)"})}return s}function j(e){let{completionConfig:t,...r}=e,a=(0,v.Z)(),o="dark"===a.palette.mode,n=(0,h.useMemo)(()=>(function(e){let t=k.qp.define({parser:T.E2.configure({props:[x]}),languageData:{closeBrackets:{brackets:["(","[","{","'",'"',"`"]},commentTokens:{line:"//"}}}),r=t.data.of({autocomplete:t=>D(e,t).catch(e=>console.error("error during TraceQL auto-complete",e))});return[t,r]})(t),[t]),s=(0,h.useMemo)(()=>{let e="light"===a.palette.mode?"rgba(0, 0, 0, 0.23)":"rgba(255, 255, 255, 0.23)";return b.tk.theme({"&":{backgroundColor:"transparent !important",border:`1px solid ${e}`,borderRadius:`${a.shape.borderRadius}px`},"&.cm-focused.cm-editor":{outline:"none"},".cm-content":{padding:"8px"}})},[a]);return(0,u.jsxs)(d.Z,{position:"relative",sx:{flexGrow:1},children:[(0,u.jsx)(y.Z,{shrink:!0,sx:{position:"absolute",top:"-6px",left:"10px",padding:"0 4px",color:a.palette.text.primary,backgroundColor:a.palette.background.default,zIndex:1},children:"TraceQL Expression"}),(0,u.jsx)(b.ZP,{...r,theme:o?"dark":"light",basicSetup:{lineNumbers:!1,highlightActiveLine:!1,highlightActiveLineGutter:!1,foldGutter:!1,syntaxHighlighting:!(0,i.j)(r.value??"")},extensions:[b.tk.lineWrapping,n,s],placeholder:'Example: {span.http.method = "GET"}'})]})}let L={getTraceData:l,OptionsEditorComponent:function(e){let{onChange:t,value:r}=e,{datasource:i}=r,o=i??s,l=(0,a.useDatasourceSelectValueToSelector)(o,n),c=(0,f.useId)("tempo-datasource-label"),{data:v}=(0,a.useDatasourceClient)(l),{timeRange:y}=(0,a.useTimeRange)(),b=(0,h.useMemo)(()=>({client:v,timeRange:y}),[v,y]),{query:k,handleQueryChange:T,handleQueryBlur:S}=function(e){let{onChange:t,value:r}=e,[a,i]=(0,h.useState)(r.query),[o,n]=(0,h.useState)(r.query);return r.query!==o&&(i(r.query),n(r.query)),{query:a,handleQueryChange:e=>{i(e)},handleQueryBlur:()=>{n(a),t((0,g.Uy)(r,e=>{e.query=a}))}}}(e),{limit:x,handleLimitChange:C,handleLimitBlur:I,limitHasError:D}=function(e){let{onChange:t,value:r}=e,[a,i]=(0,h.useState)(r.limit?r.limit.toString():""),[o,n]=(0,h.useState)(r.limit);r.limit!==o&&(i(r.limit?r.limit.toString():""),n(r.limit));let s=!(""===a||/^[0-9]+$/.test(a)&&parseInt(a)>0);return{limit:a,handleLimitChange:e=>{i(e)},handleLimitBlur:()=>{if(s)return;let e=""===a?void 0:parseInt(a);n(e),t((0,g.Uy)(r,t=>{t.limit=e}))},limitHasError:s}}(e);return(0,u.jsxs)(d.Z,{spacing:2,children:[(0,u.jsx)(p.Z,{margin:"dense",fullWidth:!1,children:(0,u.jsx)(a.DatasourceSelect,{datasourcePluginKind:n,value:o,onChange:e=>{if((0,a.isVariableDatasource)(e)||e.kind===n){t((0,g.Uy)(r,t=>{let r=(0,a.isVariableDatasource)(e)||void 0!==e.name?e:void 0;t.datasource=r}));return}throw Error("Got unexpected non-Tempo datasource selector")},labelId:c,label:"Tempo Datasource",notched:!0})}),(0,u.jsxs)(d.Z,{direction:"row",spacing:2,children:[(0,u.jsx)(j,{completionConfig:b,value:k,onChange:T,onBlur:S}),(0,u.jsx)(m.Z,{size:"small",label:"Max Traces",value:x,error:D,onChange:e=>C(e.target.value),onBlur:I,sx:{width:"110px"}})]})]})},createInitialOptions:()=>({query:"",limit:20,datasource:void 0}),dependsOn:e=>({variables:[...(0,a.isVariableDatasource)(e.datasource)?(0,a.parseVariables)(e.datasource??""):[]]})}}}]);