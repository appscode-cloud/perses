{"version":3,"sources":["../../../src/components/FlameChartPanel.tsx"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { TitleComponentOption } from 'echarts';\nimport { useChartsTheme } from '@perses-dev/components';\nimport { Stack, Typography, SxProps, useMediaQuery, useTheme } from '@mui/material';\nimport { FC, useState, useEffect } from 'react';\nimport { ProfileData } from '@perses-dev/core';\nimport { PanelProps } from '@perses-dev/plugin-system';\nimport { FlameChartOptions } from '../flame-chart-model';\nimport { FlameChart } from './FlameChart';\nimport { Settings } from './Settings';\nimport { TableChart } from './TableChart';\nimport { SeriesChart } from './SeriesChart';\n\nconst LARGE_PANEL_TRESHOLD = 600;\nconst DEFAULT_SERIES_CHART_HEIGHT = 200;\n\nexport type FlameChartPanelProps = PanelProps<FlameChartOptions, ProfileData>;\n\nexport const FlameChartPanel: FC<FlameChartPanelProps> = (props) => {\n  const { contentDimensions, queryResults, spec } = props;\n\n  const isMobileSize = useMediaQuery(useTheme().breakpoints.down('sm'));\n\n  // selectedId equals 0 => Flame Graph is not zoomed in\n  // selectedId different from 0 => Flame Graph is zoomed in\n  const [selectedId, setSelectedId] = useState(0);\n  const [searchValue, setSearchValue] = useState('');\n\n  // This spec is used to manage settings temporarily\n  const [liveSpec, setLiveSpec] = useState<FlameChartOptions>(spec);\n\n  // keep liveSpec up to date\n  useEffect(() => {\n    setLiveSpec(spec);\n    setSelectedId(0);\n    setSearchValue('');\n  }, [spec]);\n\n  const chartsTheme = useChartsTheme();\n  const flameChartData = queryResults[0];\n\n  if (contentDimensions === undefined) return null;\n\n  const noDataTextStyle = (chartsTheme.noDataOption.title as TitleComponentOption).textStyle as SxProps;\n\n  const onChangePalette = (newPalette: 'package-name' | 'value') => {\n    setLiveSpec((prev) => {\n      return { ...prev, palette: newPalette };\n    });\n  };\n\n  const onDisplayChange = (value: 'table' | 'flame-graph' | 'both' | 'none') => {\n    let showTable = true;\n    let showFlameGraph = true;\n    if (value === 'table') {\n      showFlameGraph = false;\n    } else if (value === 'flame-graph') {\n      showTable = false;\n    }\n    setLiveSpec((prev) => {\n      return { ...prev, showTable: showTable, showFlameGraph: showFlameGraph };\n    });\n  };\n\n  const PADDING =\n    liveSpec.showSeries && liveSpec.showSettings ? 32 : liveSpec.showSeries || liveSpec.showSettings ? 16 : 0;\n\n  const SETTINGS_HEIGHT = liveSpec.showSettings ? 30 : 0;\n  const SERIES_CHART_HEIGHT = liveSpec.showSeries\n    ? contentDimensions.height < DEFAULT_SERIES_CHART_HEIGHT\n      ? contentDimensions.height\n      : DEFAULT_SERIES_CHART_HEIGHT\n    : 0;\n  const TABLE_FLAME_CHART_HEIGHT =\n    contentDimensions.height -\n    (contentDimensions.height > LARGE_PANEL_TRESHOLD ? SERIES_CHART_HEIGHT + SETTINGS_HEIGHT + PADDING : 0);\n\n  const TABLE_CHART_WIDTH = isMobileSize\n    ? contentDimensions.width\n    : liveSpec.showFlameGraph\n      ? 0.4 * contentDimensions.width\n      : contentDimensions.width;\n\n  const FLAME_CHART_WIDTH = isMobileSize\n    ? contentDimensions.width\n    : liveSpec.showTable\n      ? 0.6 * contentDimensions.width\n      : contentDimensions.width;\n\n  return (\n    <Stack\n      height={contentDimensions.height}\n      width={contentDimensions.width}\n      justifyContent=\"center\"\n      alignItems=\"center\"\n    >\n      {queryResults.length > 1 ? (\n        // display a message if there is more than one query\n        <Typography sx={{ ...noDataTextStyle }}>\n          There is more than one query. Please make sure that you provided only one query.\n        </Typography>\n      ) : flameChartData ? (\n        <Stack\n          gap={2}\n          sx={{ overflowY: 'auto', scrollbarGutter: 'stable both-edges', paddingTop: liveSpec.showSeries ? 0 : 1 }}\n        >\n          {liveSpec.showSeries && (\n            <SeriesChart width={contentDimensions.width} height={SERIES_CHART_HEIGHT} data={flameChartData.data} />\n          )}\n          {liveSpec.showSettings && (\n            <Settings\n              onSelectedIdChange={setSelectedId}\n              onChangePalette={onChangePalette}\n              onDisplayChange={onDisplayChange}\n              value={liveSpec}\n              selectedId={selectedId}\n            />\n          )}\n          <Stack\n            direction={isMobileSize ? 'column' : 'row'}\n            justifyContent=\"center\"\n            alignItems={isMobileSize ? 'center' : 'top'}\n          >\n            {liveSpec.showTable && (\n              <TableChart\n                width={TABLE_CHART_WIDTH}\n                height={TABLE_FLAME_CHART_HEIGHT}\n                data={flameChartData.data}\n                searchValue={searchValue}\n                onSearchValueChange={setSearchValue}\n                onSelectedIdChange={setSelectedId}\n              />\n            )}\n            {liveSpec.showFlameGraph && (\n              <FlameChart\n                width={FLAME_CHART_WIDTH}\n                height={TABLE_FLAME_CHART_HEIGHT}\n                data={flameChartData.data}\n                palette={liveSpec.palette}\n                selectedId={selectedId}\n                searchValue={searchValue}\n                onSelectedIdChange={setSelectedId}\n              />\n            )}\n          </Stack>\n        </Stack>\n      ) : (\n        <Typography sx={{ ...noDataTextStyle }}>No data</Typography>\n      )}\n    </Stack>\n  );\n};\n"],"names":["useChartsTheme","Stack","Typography","useMediaQuery","useTheme","useState","useEffect","FlameChart","Settings","TableChart","SeriesChart","LARGE_PANEL_TRESHOLD","DEFAULT_SERIES_CHART_HEIGHT","FlameChartPanel","props","contentDimensions","queryResults","spec","isMobileSize","breakpoints","down","selectedId","setSelectedId","searchValue","setSearchValue","liveSpec","setLiveSpec","chartsTheme","flameChartData","undefined","noDataTextStyle","noDataOption","title","textStyle","onChangePalette","newPalette","prev","palette","onDisplayChange","value","showTable","showFlameGraph","PADDING","showSeries","showSettings","SETTINGS_HEIGHT","SERIES_CHART_HEIGHT","height","TABLE_FLAME_CHART_HEIGHT","TABLE_CHART_WIDTH","width","FLAME_CHART_WIDTH","justifyContent","alignItems","length","sx","gap","overflowY","scrollbarGutter","paddingTop","data","onSelectedIdChange","direction","onSearchValueChange"],"mappings":"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"}