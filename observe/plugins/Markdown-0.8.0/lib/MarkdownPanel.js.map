{"version":3,"sources":["../../src/MarkdownPanel.tsx"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Box, Theme } from '@mui/material';\nimport { PersesChartsTheme, useChartsTheme } from '@perses-dev/components';\nimport { PanelProps, useReplaceVariablesInString } from '@perses-dev/plugin-system';\nimport DOMPurify from 'dompurify';\nimport { marked } from 'marked';\nimport React, { ReactElement, useMemo } from 'react';\nimport { MarkdownPanelOptions } from './markdown-panel-model';\n\nexport type MarkdownPanelProps = PanelProps<MarkdownPanelOptions>;\n\nfunction createMarkdownPanelStyles(theme: Theme, chartsTheme: PersesChartsTheme): Record<string, unknown> {\n  return {\n    padding: `${chartsTheme.container.padding.default}px`,\n    // Make the content scrollable\n    height: '100%',\n    overflowY: 'auto',\n    // Ignore top margin on the first element.\n    '& :first-of-type': {\n      marginTop: 0,\n    },\n    // Styles for headers\n    '& h1': {\n      fontSize: '2em',\n    },\n    // Styles for <code>\n    '& code': { fontSize: '0.85em' },\n    '& :not(pre) code': {\n      padding: '0.2em 0.4em',\n      backgroundColor: theme.palette.grey[100],\n      borderRadius: '4px',\n    },\n    '& pre': {\n      padding: '1.2em',\n      backgroundColor: theme.palette.grey[100],\n      borderRadius: '4px',\n    },\n    // Styles for <table>\n    '& table, & th, & td': {\n      padding: '0.6em',\n      border: `1px solid ${theme.palette.grey[300]}`,\n      borderCollapse: 'collapse',\n    },\n    // Styles for <li>\n    '& li + li': {\n      marginTop: '0.25em',\n    },\n    // Styles for <a>\n    '& a': {\n      color: theme.palette.primary.main,\n    },\n  };\n}\n\n// Convert markdown to HTML\n// Supports original markdown and GitHub Flavored markdown\nfunction markdownToHTML(text: string): string {\n  return marked.parse(text, { gfm: true, async: false });\n}\n\n// Prevent XSS attacks by removing the vectors for attacks\nfunction sanitizeHTML(html: string): string {\n  return DOMPurify.sanitize(html);\n}\n\nexport function MarkdownPanel(props: MarkdownPanelProps): ReactElement {\n  const {\n    spec: { text },\n  } = props;\n  const chartsTheme = useChartsTheme();\n\n  const textAfterVariableReplacement = useReplaceVariablesInString(text);\n\n  const html = useMemo(() => markdownToHTML(textAfterVariableReplacement ?? ''), [textAfterVariableReplacement]);\n  const sanitizedHTML = useMemo(() => sanitizeHTML(html), [html]);\n\n  return (\n    <Box\n      sx={(theme) => createMarkdownPanelStyles(theme, chartsTheme)}\n      dangerouslySetInnerHTML={{ __html: sanitizedHTML }}\n    />\n  );\n}\n"],"names":["Box","useChartsTheme","useReplaceVariablesInString","DOMPurify","marked","React","useMemo","createMarkdownPanelStyles","theme","chartsTheme","padding","container","default","height","overflowY","marginTop","fontSize","backgroundColor","palette","grey","borderRadius","border","borderCollapse","color","primary","main","markdownToHTML","text","parse","gfm","async","sanitizeHTML","html","sanitize","MarkdownPanel","props","spec","textAfterVariableReplacement","sanitizedHTML","sx","dangerouslySetInnerHTML","__html"],"mappings":"AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;AAEjC,SAASA,GAAG,QAAe,gBAAgB;AAC3C,SAA4BC,cAAc,QAAQ,yBAAyB;AAC3E,SAAqBC,2BAA2B,QAAQ,4BAA4B;AACpF,OAAOC,eAAe,YAAY;AAClC,SAASC,MAAM,QAAQ,SAAS;AAChC,OAAOC,SAAuBC,OAAO,QAAQ,QAAQ;AAKrD,SAASC,0BAA0BC,KAAY,EAAEC,WAA8B;IAC7E,OAAO;QACLC,SAAS,GAAGD,YAAYE,SAAS,CAACD,OAAO,CAACE,OAAO,CAAC,EAAE,CAAC;QACrD,8BAA8B;QAC9BC,QAAQ;QACRC,WAAW;QACX,0CAA0C;QAC1C,oBAAoB;YAClBC,WAAW;QACb;QACA,qBAAqB;QACrB,QAAQ;YACNC,UAAU;QACZ;QACA,oBAAoB;QACpB,UAAU;YAAEA,UAAU;QAAS;QAC/B,oBAAoB;YAClBN,SAAS;YACTO,iBAAiBT,MAAMU,OAAO,CAACC,IAAI,CAAC,IAAI;YACxCC,cAAc;QAChB;QACA,SAAS;YACPV,SAAS;YACTO,iBAAiBT,MAAMU,OAAO,CAACC,IAAI,CAAC,IAAI;YACxCC,cAAc;QAChB;QACA,qBAAqB;QACrB,uBAAuB;YACrBV,SAAS;YACTW,QAAQ,CAAC,UAAU,EAAEb,MAAMU,OAAO,CAACC,IAAI,CAAC,IAAI,EAAE;YAC9CG,gBAAgB;QAClB;QACA,kBAAkB;QAClB,aAAa;YACXP,WAAW;QACb;QACA,iBAAiB;QACjB,OAAO;YACLQ,OAAOf,MAAMU,OAAO,CAACM,OAAO,CAACC,IAAI;QACnC;IACF;AACF;AAEA,2BAA2B;AAC3B,0DAA0D;AAC1D,SAASC,eAAeC,IAAY;IAClC,OAAOvB,OAAOwB,KAAK,CAACD,MAAM;QAAEE,KAAK;QAAMC,OAAO;IAAM;AACtD;AAEA,0DAA0D;AAC1D,SAASC,aAAaC,IAAY;IAChC,OAAO7B,UAAU8B,QAAQ,CAACD;AAC5B;AAEA,OAAO,SAASE,cAAcC,KAAyB;IACrD,MAAM,EACJC,MAAM,EAAET,IAAI,EAAE,EACf,GAAGQ;IACJ,MAAM1B,cAAcR;IAEpB,MAAMoC,+BAA+BnC,4BAA4ByB;IAEjE,MAAMK,OAAO1B,QAAQ,IAAMoB,eAAeW,gCAAgC,KAAK;QAACA;KAA6B;IAC7G,MAAMC,gBAAgBhC,QAAQ,IAAMyB,aAAaC,OAAO;QAACA;KAAK;IAE9D,qBACE,KAAChC;QACCuC,IAAI,CAAC/B,QAAUD,0BAA0BC,OAAOC;QAChD+B,yBAAyB;YAAEC,QAAQH;QAAc;;AAGvD"}